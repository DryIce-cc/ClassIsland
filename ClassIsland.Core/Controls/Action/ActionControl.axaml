<UserControl x:Class="ClassIsland.Core.Controls.Action.ActionControl"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ci="http://classisland.tech/schemas/xaml/core"
             xmlns:fa="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             xmlns:local="clr-namespace:ClassIsland.Core.Controls.Action"

             xmlns:controls="clr-namespace:ClassIsland.Core.Controls">
    <UserControl.Resources>
        <ci:PreventNullConverter x:Key="PreventNullConverter" />
    </UserControl.Resources>
    <StackPanel DataContext="$parent[local:ActionControl]">
        <ItemsControl ItemsSource="{Binding $parent[local:ActionControl].ActionSet.ActionItems}"
                      HorizontalAlignment="Stretch">
            <Interaction.Behaviors>
                <ItemDragBehavior />
            </Interaction.Behaviors>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid ColumnDefinitions="Auto, Auto, *, Auto, Auto" Margin="0 4">
                            <Button Grid.Column="0" Grid.Row="0"
                                    Margin="0 0 2 0"
                                    Theme="{StaticResource TransparentButton}"
                                    Classes="circle"
                                    ToolTip.Tip="删除"
                                    Command="{Binding RemoveActionCommand, RelativeSource={RelativeSource AncestorType=local:ActionControl}}"
                                    CommandParameter="{Binding}"
                                    Content="{controls:FluentIcon &#xE671;}"
                                    Height="32.5"
                                    VerticalAlignment="Top"
                                    VerticalContentAlignment="Center">
                            </Button>
                            <ComboBox Grid.Column="1" Grid.Row="0"
                                      SelectedValue="{Binding Id, Converter={StaticResource PreventNullConverter}}"
                                      SelectedValueBinding="{Binding Key}"
                                      ItemsSource="{Binding  $parent[local:ActionControl].ActionInfos}"
                                      MinWidth="100">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <controls:IconText Glyph="{Binding Value.IconGlyph}"
                                                           Text="{Binding Value.Name}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            <local:ActionSettingsControlPresenter ActionItem="{Binding}"
                                                                  Margin="4 0 0 0"
                                                                  Grid.Column="2" Grid.Row="0"/>
                            <fa:ProgressRing IsIndeterminate="{Binding Progress, Converter={x:Static ObjectConverters.IsNull}}"
                                          Grid.Column="3" Grid.Row="0" IsVisible="{Binding IsWorking}"
                                          Value="{Binding Progress, TargetNullValue=0}"
                                          Height="32.5"
                                          VerticalAlignment="Top"/>
                            <Button Grid.Column="4" Grid.Row="0"
                                    ToolTip.Tip="上次运行此行动时出现错误。"
                                    Theme="{StaticResource TransparentButton}"
                                    Classes="circle"
                                    Foreground="Red"
                                    IsVisible="{Binding Exception, Converter={x:Static ObjectConverters.IsNotNull}}"
                                    Content="{controls:FluentIcon &#xE809;}"
                                    Height="32.5"
                                    VerticalAlignment="Top"
                                    VerticalContentAlignment="Center">
                                <Button.Flyout>
                                    <Flyout>
                                        <TextBox Text="{Binding Exception, Mode=OneWay}"
                                                 IsReadOnly="True"
                                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                 ScrollViewer.HorizontalScrollBarVisibility="Auto" />
                                    </Flyout>
                                </Button.Flyout>
                            </Button>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
        <Button Theme="{StaticResource TransparentButton}" Classes="primary"
                        HorizontalAlignment="Left"
                        IsVisible="{Binding IsEnabled, RelativeSource={RelativeSource FindAncestor, AncestorType=local:ActionControl}}">
            <controls:IconText Glyph="&#xE00D;" Text="添加行动"
                               Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
            <Button.Flyout>
                <fa:FAMenuFlyout ItemsSource="{Binding $parent[local:ActionControl].ActionInfos}">
                    <fa:FAMenuFlyout.ItemTemplate>
                        <DataTemplate>
                            <fa:MenuFlyoutItem Text="{Binding Value.Name}"
                                               Command="{Binding $parent[local:ActionControl].AddActionCommand}"
                                               CommandParameter="{Binding Value.Id}">
                                <fa:MenuFlyoutItem.IconSource>
                                    <ci:FluentIconSource Glyph="{Binding Value.IconGlyph}"/>
                                </fa:MenuFlyoutItem.IconSource>
                            </fa:MenuFlyoutItem>
                        </DataTemplate>
                    </fa:FAMenuFlyout.ItemTemplate>
                </fa:FAMenuFlyout>
            </Button.Flyout>
        </Button>
    </StackPanel>
</UserControl>

